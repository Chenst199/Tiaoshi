<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>我的在线 PDF 库</title>
<style>
  body{font-family:"微软雅黑",sans-serif;background:#f5f7f8;color:#222;margin:0}
  header{background:#2b7a78;color:#fff;padding:16px;text-align:center;font-weight:700}
  .container{max-width:980px;margin:20px auto;padding:12px}
  .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .btn{background:#2b7a78;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
  .btn.secondary{background:#6aa6a2}
  .search{flex:1;min-width:200px;padding:8px;border-radius:6px;border:1px solid #ddd}
  .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{background:#fff;padding:10px;border-radius:8px;box-shadow:0 2ppx 8px rgba(0,0,0,0.06);display:flex;align-items:center;gap:10px}
  .thumb{width:56px;height:72px;background:#eef4f3;border-radius:4px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2b7a78}
  .info{flex:1;overflow:hidden}
  .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{font-size:0.85em;color:#666;margin-top:6px}
  .actions{display:flex;gap:8px}
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:200}
  .viewer{width:90%;height:90%;max-width:1100px;background:#fff;border-radius:8px;display:flex;flex-direction:column;overflow:hidden}
  .viewer-head{padding:8px 12px;background:#f2f6f5;display:flex;align-items:center;justify-content:space-between}
  .viewer-body{flex:1;background:#333}
  .viewer-body iframe{width:100%;height:100%;border:0}
  .empty{padding:36px;text-align:center;color:#666}
  @media(max-width:560px){.thumb{width:46px;height:60px}}
</style>
</head>
<body>
<header>我的在线 PDF 库</header>
<div class="container">
  <div class="controls">
    <input id="search" class="search" placeholder="搜索 PDF 文件名..." />
    <button id="refresh" class="btn secondary">刷新列表</button>
    <div style="margin-left:auto;color:#666;font-size:0.9em">说明：请将 PDF 上传到仓库根目录；页面读取根目录的 list.json</div>
  </div>

  <div id="pdfList" class="list" aria-live="polite"></div>
  <div id="empty" class="empty" style="display:none">
    没有找到可显示的 PDF。<br/>
    如果你已把 PDF 上传到仓库根目录，请在仓库根添加一个 list.json 文件，内容是 JSON 数组，例如：<br/>
    <code>[{"name":"说明.pdf","filename":"说明.pdf","uploaded_at":"2026-01-14"}]</code><br/>
    或把你上传的 PDF 文件名（例如：说明.pdf, 报表.pdf）发给我，我可以为你创建 list.json 并提交。
  </div>
</div>

<!-- Viewer Modal -->
<div id="modal" class="modal-bg" aria-hidden="true">
  <div class="viewer" role="dialog" aria-modal="true">
    <div class="viewer-head">
      <div id="title" style="font-weight:700;color:#2b7a78">文件名.pdf</div>
      <div>
        <a id="openNew" class="btn secondary" target="_blank" rel="noopener">在新标签打开</a>
        <button id="closeBtn" style="margin-left:8px;border:0;background:transparent;font-size:1.2em;cursor:pointer">✕</button>
      </div>
    </div>
    <div class="viewer-body">
      <iframe id="frame" src=""></iframe>
    </div>
  </div>
</div>

<script>
  // 配置：list.json 在仓库根（/list.json）
  const LIST_URL = '/list.json'; // 必须存在于远端站点根
  const pdfListEl = document.getElementById('pdfList');
  const emptyEl = document.getElementById('empty');
  const searchEl = document.getElementById('search');
  const refreshBtn = document.getElementById('refresh');

  let items = [];

  async function loadList() {
    items = [];
    try {
      const res = await fetch(LIST_URL, {cache: 'no-store'});
      if(!res.ok) throw new Error('no list.json');
      const data = await res.json();
      if(!Array.isArray(data)) throw new Error('list.json 格式不对');
      // 允许两种格式： {name, filename, uploaded_at, url} 或 仅 filename 字符串
      items = data.map(entry => {
        if(typeof entry === 'string') {
          return { name: decodeURIComponent(entry), filename: entry };
        }
        // 如果 entry.url 存在，就用它；否则构造根路径 URL
        const url = entry.url ? entry.url : ('/' + encodeURIComponent(entry.filename || entry.name || ''));
        return {
          name: entry.name || entry.filename || (url.split('/').pop()),
          filename: entry.filename || entry.name || (url.split('/').pop()),
          url,
          uploaded_at: entry.uploaded_at || entry.uploadedAt || ''
        };
      });
    } catch (err) {
      console.warn('读取 list.json 失败：', err);
      items = [];
    }
    render();
  }

  function render() {
    const q = (searchEl.value || '').trim().toLowerCase();
    pdfListEl.innerHTML = '';
    const filtered = items.filter(it => !q || (it.name && it.name.toLowerCase().includes(q)));
    if(filtered.length === 0) {
      emptyEl.style.display = 'block';
      return;
    }
    emptyEl.style.display = 'none';
    filtered.forEach(it => {
      const url = it.url ? it.url : ('/' + encodeURIComponent(it.filename));
      const card = document.createElement('div'); card.className = 'card';
      const thumb = document.createElement('div'); thumb.className = 'thumb'; thumb.textContent = 'PDF';
      const info = document.createElement('div'); info.className = 'info';
      const name = document.createElement('div'); name.className = 'name'; name.textContent = it.name; name.title = it.name;
      const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = it.uploaded_at ? ('上传：' + it.uploaded_at) : url;
      info.appendChild(name); info.appendChild(meta);
      const actions = document.createElement('div'); actions.className = 'actions';
      const viewBtn = document.createElement('button'); viewBtn.className = 'btn'; viewBtn.textContent = '查看';
      viewBtn.onclick = () => openViewer(it, url);
      const dl = document.createElement('a'); dl.className = 'btn secondary'; dl.textContent = '下载'; dl.href = url; dl.target = '_blank'; dl.rel = 'noopener';
      actions.appendChild(viewBtn); actions.appendChild(dl);
      card.appendChild(thumb); card.appendChild(info); card.appendChild(actions);
      pdfListEl.appendChild(card);
    });
  }

  // Viewer
  const modal = document.getElementById('modal');
  const frame = document.getElementById('frame');
  const titleEl = document.getElementById('title');
  const openNew = document.getElementById('openNew');
  const closeBtn = document.getElementById('closeBtn');

  function openViewer(item, url) {
    const fileUrl = url || (item.url ? item.url : ('/' + encodeURIComponent(item.filename)));
    titleEl.textContent = item.name || item.filename;
    openNew.href = fileUrl;
    // 使用浏览器内置 PDF 查看器（iframe）
    frame.src = fileUrl;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
  }
  function closeViewer() {
    frame.src = '';
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }
  closeBtn.onclick = closeViewer;
  modal.onclick = (e) => { if(e.target === modal) closeViewer(); }

  // 事件
  refreshBtn.onclick = loadList;
  searchEl.addEventListener('input', render);

  // 首次加载：尝试从 list.json 获取
  loadList();
</script>
</body>
</html>
